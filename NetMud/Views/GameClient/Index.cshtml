@model NetMud.Models.GameContextModel
<div class="parserClientTop">
    <div id="locationBreadcrumbs">
        <span class="contentContainer" output-data-binding="Local.ZoneName"></span>
        <span class="contentContainer" output-eval-key="Local.LocaleName" output-eval-code="if(data.length === 0) { element.css({'display': 'none'}); } else { element.css({'display' : 'block'}); }">&nbsp;>&nbsp;<span output-data-binding="Local.LocaleName"></span></span>
        <span class="contentContainer" output-eval-key="Local.RoomName" output-eval-code="if(data.length === 0) { element.css({'display': 'none'}); } else { element.css({'display' : 'block'}); }">&nbsp;>&nbsp;<span output-data-binding="Local.RoomName"></span></span>
    </div>
    <div id="locationDescription">
        <span class="contentContainer" output-data-binding="Local.LocationDescriptive"></span>
    </div>
    <div class="rightNav" style="float: right;">
        <a class="dropdown-toggle" data-toggle="dropdown" href="#"><span class="glyphicon glyphicon-th-list" title="Client Settings"></span></a>
        <ul class="dropdown-menu dropdown-menu-left" role="menu" aria-labelledby="dropdownMenu">
            <li class="dropdown-header" style="color: mediumvioletred">Global UI Settings</li>
            <li><a href="#" style="padding: 5px; color: black;" id="clientReload"><span class="glyphicon glyphicon-refresh" style="padding-right: 5px;"></span>Reload Client</a></li>
            <li><a href="#" style="padding: 5px; color: black;" id="openModulePopup"><span class="glyphicon glyphicon-open" style="padding-right: 5px;"></span>Popup Module</a></li>
            <li class="divider"></li>
            <li><a href="#" style="padding: 5px; color: black;" id="saveAllModules"><span class="glyphicon glyphicon-upload" style="padding-right: 5px;"></span>Save All Modules</a></li>
            <li><a href="#" style="padding: 5px; color: black;" id="reloadAllModules"><span class="glyphicon glyphicon-download" style="padding-right: 5px;"></span>Load UI From Config</a></li>
            <li><a href="#" style="padding: 5px; color: black;" id="wipeUI"><span class="glyphicon glyphicon-remove" style="padding-right: 5px;"></span>Wipe UI</a></li>
            <li class="divider"></li>
            <li><a href="#" style="padding: 5px; color: black;" id="disconnect"><span class="glyphicon glyphicon-remove-sign" style="padding-right: 5px;"></span>Disconnect From Server</a></li>
        </ul>
    </div>
</div>
<div class="parserClient">
    <div class="parserClientLeft sidebar">
        <div id="quadrant-1" data-module-name="" quadrant-number="1" class="quadrant">
            @Html.Partial("DockerSettings", 1)
        </div>
        <div id="quadrant-2" data-module-name="" quadrant-number="2" class="quadrant">
            @Html.Partial("DockerSettings", 2)
        </div>
    </div>
    <div class="parserClientRight sidebar">
        <div id="quadrant-3" data-module-name="" quadrant-number="3" class="quadrant">
            @Html.Partial("DockerSettings", 3)
        </div>
        <div id="quadrant-4" data-module-name="" quadrant-number="4" class="quadrant">
            @Html.Partial("DockerSettings", 4)
        </div>
    </div>
    <div class="textParserClient">
        <div id="OutputArea" class="parserOutput"></div>
        <input type="text" id="input" name="input" class="parserInput" />
    </div>
</div>
@Styles.Render("~/Content/GameClient.css")
@Scripts.Render("~/Scripts/ClientHelpers.js")
@Scripts.Render("~/Scripts/WebSocketsClient.js")
@Styles.Render("http://fonts.googleapis.com/css?family=Berkshire+Swash")

<script type="text/javascript">
    $(document).ready(function () {
        $('input#loadModuleName').hide();

        var tutorialMode = '@Model.authedUser.GameAccount.Config.UITutorialMode' === 'True';
        Tutorial($('#locationBreadcrumbs'), "This is where you are in the world.", tutorialMode);
        Tutorial($('#input'), "This is where you type commands. The UP and DOWN arrow keys will cycle through prior input. Hit ENTER to submit commands.", tutorialMode);
        LoadUIModules();

        $('#disconnect').click(function (e) {
            $('#input').val('');
            $("#OutputArea").html('');
            $("#OutputArea")[0].scrollTop = $("#OutputArea")[0].scrollHeight;

            AppendTextToOutput('Connection TERMINATED.');
            window.connection.close();

            WipeUI();

            $('disconnect').off('click');
            return false;
        });

        $(".quadrantDocker[data-destination-quadrant!='-1']").click(function (e) {
            var $this = $(this);

            var originNumber = $this.attr('data-origin-quadrant');
            var $origin = $('div#quadrant-' + originNumber + '.quadrant');
            var originName = $origin.attr('data-module-name');

            var destinationNumber = $this.attr('data-destination-quadrant');
            var $destination = $('div#quadrant-' + destinationNumber + '.quadrant');
            var destinationName = $destination.attr('data-module-name');

            var myContent = $origin.children('.contentContainer');
            var theirContent = $destination.children('.contentContainer');

            myContent.detach();
            theirContent.detach();

            myContent.appendTo($destination);
            theirContent.appendTo($origin);

            $origin.attr('data-module-name', destinationName);
            $destination.attr('data-module-name', originName);

            $origin.children('ul').children('li#quadrantName').text(destinationName);
            $destination.children('ul').children('li#quadrantName').text(originName);
            return false;
       });

        $(".quadrantDocker[data-destination-quadrant='-1']").click(function (e) {
            var $this = $(this);

            var originNumber = $this.attr('data-origin-quadrant');
            var $origin = $('div#quadrant-' + originNumber + '.quadrant');
            var originName = $origin.attr('data-module-name');

            var myContent = $origin.children('.contentContainer');

            myContent.detach();
            $origin.attr('data-module-name', 'Quadrant ' + originNumber);
            $origin.children('ul').children('li#quadrantName').text('Quadrant ' + originNumber);

            openModularUI(500, 500, originName, myContent);
            return false;
        });

        $(".quadrantLoad").click(function (e) {
            var $this = $(this);

            $('input#loadModuleName').show().focus();
            $(this).hide();

            $('input#loadModuleName').keydown(function (e) {
                var moduleName = $(this).val();
                var originNumber = $(this).prev().attr('data-origin-quadrant');

                switch (e.keyCode) {
                    case 13: //enter
                        GetModuleUI(originNumber, moduleName);
                        break;
                    default:
                        return true;
                }

                $('input#loadModuleName').off('keydown');
                $('input#loadModuleName').hide();
                $(".quadrantLoad").show();
            });

            return false;
       });

        $(".quadrantSave").click(function (e) {
            var $this = $(this);

            var originNumber = $this.attr('data-origin-quadrant');
            SaveUIModule(originNumber);
            return false;
        });

        $('.quadrantWipe').click(function (e) {
            var $this = $(this);

            var originNumber = $this.attr('data-origin-quadrant');

            var $origin = $('div#quadrant-' + originNumber + '.quadrant');
            $origin.attr('data-module-name', '');
            $origin.children('ul').children('li#quadrantName').text('');

            var myContent = $origin.children('.contentContainer');

            myContent.detach();

            return false;
        });

        $("#clientReload").click(function (e) {
            ReloadUI();
            return false;
       });

        $("#reloadAllModules").click(function (e) {
            LoadUIModules();
            return false;
       });

        $('#wipeUI').click(function (e) {
            WipeUI();
            return false;
        });

        $("#saveAllModules").click(function (e) {
            SaveUIModule(1);
            SaveUIModule(2);
            SaveUIModule(3);
            SaveUIModule(4);

            window.openedWindows.forEach(function (win) {
                var wTest = window.open("", win.name);

                if (wTest.document.querySelector('#contentArea') != undefined) {
                    var contentArea = win.window.document.querySelector('#contentArea');

                    var moduleName = $(contentArea).attr('data-module-name');
                    $.post('/api/ClientDataApi/SaveUIModuleContent/' + moduleName + '/-1');
                } else {
                    //remove it
                    $.post('/api/ClientDataApi/RemoveUIModuleContent/' + win.name + '/-1');
                }
            });

            return false;
        });

        $('#openModulePopup').click(function (e) {
            var moduleName = prompt("Module Name?", "");

            $.get('/api/ClientDataApi/GetUIModuleContent/' + moduleName, function (data) {
                var newContent = data.BodyHtml;

                if (newContent != '') {
                    openModularUI(500, 500, moduleName, newContent);

                    ReloadUI();
                }
            });
            return false;
        });

        $("input#loadModuleName").autocomplete({
            source: "/api/ClientDataApi/GetUIModuleNames",
            minLength: 3,
            select: function (event, ui) {
                var originNumber = $(this).prev().attr('data-origin-quadrant');
                GetModuleUI(originNumber, ui.item.value);

                $('input#loadModuleName').hide();
                $(".quadrantLoad").show();
            }
        });
    });

    function GetModuleUI(originNumber, moduleName) {
        $.get('/api/ClientDataApi/GetUIModuleContent/' + moduleName, function (data) {
            var newContent = data.BodyHtml;

            if (newContent != '') {
                var $origin = $('div#quadrant-' + originNumber + '.quadrant');
                $origin.attr('data-module-name', data.Name);
                $origin.children('ul').children('li#quadrantName').text(data.Name);

                var myContent = $origin.children('.contentContainer');

                myContent.detach();

                $(newContent).appendTo($origin);

                ReloadUI();
            }
        });
    }

    function WipeUI() {
        $('.quadrant').each(function () {
            var $quad = $(this);

            var quadNumber = $quad.attr('quadrant-number');
            $quad.attr('data-module-name', 'Quadrant ' + quadNumber);
            $quad.children('ul').children('li#quadrantName').text('Quadrant ' + quadNumber);

            var myContent = $quad.children('.contentContainer');

            myContent.detach();
        });

        window.openedWindows.forEach(function (win) {
            win.close();
        });
    }

    function SaveUIModule(originNumber) {
        var $origin = $('div#quadrant-' + originNumber + '.quadrant');
        var moduleName = $origin.attr('data-module-name');

        if (moduleName != '') {
            $.post('/api/ClientDataApi/SaveUIModuleContent/' + moduleName + '/' + originNumber);
        } else {
            //remove it
            $.post('/api/ClientDataApi/RemoveUIModuleContent/**anymodule**/' + originNumber);
        }
    }

    function LoadUIModules() {
        window.UILoading = true;

        $.get('/api/ClientDataApi/LoadUIModules', function (data) {
            for (var i = 0; i < data.length; i++) {
                var obj = data[i];
                var quadrant = obj.Item2;
                var module = obj.Item1;

                var moduleContent = module.BodyHtml;

                if (moduleContent != '') {
                    var $origin = $('div#quadrant-' + quadrant + '.quadrant');

                    $origin.children('.contentContainer').detach();

                    if (quadrant == -1) {
                        openModularUI(500, 500, module.Name, moduleContent);
                    } else {
                        $origin.attr('data-module-name', module.Name);
                        $origin.children('ul').children('li#quadrantName').text(module.Name);

                        $(moduleContent).appendTo($origin);
                    }
                }
            }

            window.UILoading = false;

            ReloadUI();
        });
    }
</script>
